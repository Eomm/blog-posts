import Fastify from 'fastify';
import fastifyRequestContext from '@fastify/request-context';

const app = Fastify({ logger: true });

app.register(fastifyRequestContext, {
  defaultStoreValues () {
    return {
      logicStep: [],
    }
  }
});

app.get('/', async function longHandler (req, reply) {
  const debugBusiness = req.requestContext.get('logicStep');

  // do some business logic
  debugBusiness.push('called external service 1');

  // do some business logic
  debugBusiness.push('processed external service 2');

  // call another handler but..
  throw new Error('Something went wrong ğŸ˜±');
});

app.setErrorHandler(function (err, request, reply) {
  const debugBusiness = request.requestContext.get('logicStep');

  this.log.error({ err, debugBusiness }, 'An error occurred');
  reply.status(500).send('Internal Server Error');
})

app.inject('/')
// app.listen({ port: 3000 });


// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Stat    â”‚ 2.5% â”‚ 50%   â”‚ 97.5% â”‚ 99%    â”‚ Avg      â”‚ Stdev    â”‚ Max    â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Latency â”‚ 9 ms â”‚ 21 ms â”‚ 85 ms â”‚ 176 ms â”‚ 27.09 ms â”‚ 48.33 ms â”‚ 938 ms â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ Stat      â”‚ 1%  â”‚ 2.5% â”‚ 50%    â”‚ 97.5%   â”‚ Avg     â”‚ Stdev    â”‚ Min   â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Req/Sec   â”‚ 0   â”‚ 0    â”‚ 11,695 â”‚ 17,167  â”‚ 9,893.8 â”‚ 5,565.41 â”‚ 478   â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ Bytes/Sec â”‚ 0 B â”‚ 0 B  â”‚ 2.4 MB â”‚ 3.52 MB â”‚ 2.03 MB â”‚ 1.14 MB  â”‚ 98 kB â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜

// Req/Bytes counts sampled once per second.
// # of samples: 80

// 0 2xx responses, 791450 non 2xx responses
// 900k requests in 80.11s, 162 MB read
// 36k errors (0 timeouts)